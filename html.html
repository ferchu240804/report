S√≠, puedo generar el archivo HTML completo y listo para descargar con todas las
modificaciones que incluyen la funcionalidad de base de datos local usando
`localStorage`. Dado que no puedo directamente proporcionar un archivo para
descargar en este formato de interacci√≥n, te dar√© el contenido completo del
archivo. Simplemente copia todo el texto y gu√°rdalo en un archivo con la
extensi√≥n `.html`. **Instrucciones para descargar el archivo:** 1. **Copia todo
el texto** que se encuentra dentro del bloque de c√≥digo a continuaci√≥n. 2.
**Abre un editor de texto plano** en tu computadora (como Notepad en Windows,
TextEdit en Mac -aseg√∫rate de guardarlo como texto plano-, o cualquier editor de
c√≥digo como VS Code, Sublime Text, Atom, etc.). 3. **Pega el texto copiado** en
el editor. 4. **Guarda el archivo** con el nombre `control_servicios.html` (o el
nombre que prefieras, pero aseg√∫rate de que termine en `.html`). 5. **Abre este
archivo** con tu navegador web (Chrome, Firefox, Edge, etc.). --- ```html
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìã Control de Servicioss</title>
    <!-- Script para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      /* Estilos generales del cuerpo */
      body {
        font-family: Arial, sans-serif;
        margin: 10px;
        font-size: 12px;
        line-height: 1.4; /* Mejora la legibilidad del texto */
        color: #333;
      }

      /* Estilos para inputs, selects, buttons y textareas */
      input,
      select,
      button,
      textarea {
        padding: 6px; /* Aumentado para mejor interacci√≥n */
        margin: 3px 0;
        width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        border: 1px solid #ccc;
        border-radius: 4px; /* Bordes ligeramente redondeados */
      }

      button {
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 12px; /* M√°s padding para botones */
        border-radius: 4px;
        transition: background-color 0.2s ease; /* Transici√≥n suave al pasar el rat√≥n */
      }

      button:hover {
        background-color: #0056b3;
      }

      /* Estilos para tablas */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra sutil para las tablas */
      }

      th,
      td {
        border: 1px solid #ddd; /* Borde m√°s suave */
        padding: 6px; /* M√°s padding en celdas */
        text-align: center;
        page-break-inside: avoid; /* Evita que las filas se corten al imprimir */
      }

      th {
        background-color: #f2f2f2;
        font-weight: bold;
      }

      /* Secciones del formulario */
      .form-section {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 5px;
        background-color: #fff;
        page-break-inside: avoid;
      }

      /* Filas del formulario con flexbox */
      .form-row {
        display: flex;
        gap: 10px; /* Espacio entre elementos de la fila */
        margin-bottom: 5px;
        page-break-inside: avoid;
      }

      .form-row label {
        flex: 1;
        display: flex; /* Para alinear el input dentro del label */
        flex-direction: column; /* Pone el texto del label encima del input */
        font-weight: bold;
      }

      /* Elementos que no se imprimen */
      .no-print {
        display: flex;
        gap: 8px; /* Espacio entre botones */
        margin-top: 10px;
        flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas peque√±as */
        justify-content: flex-end; /* Alinea los botones a la derecha */
      }

      /* Estilos para los √≠tems del historial */
      .historial-item {
        border: 1px solid #bbb;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 4px;
        background: #f8f8f8;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .historial-item p {
        margin: 3px 0;
      }

      /* Ocultar elementos no imprimibles al imprimir */
      @media print {
        .no-print,
        .no-print * {
          display: none !important;
          visibility: hidden;
        }
        body {
          margin: 0; /* Elimina m√°rgenes del cuerpo al imprimir */
          font-size: 10px; /* Fuente m√°s peque√±a para impresi√≥n */
        }
        table,
        th,
        td {
          border-color: #999; /* Bordes m√°s oscuros para impresi√≥n */
        }
        .form-section {
          border: none; /* Elimina bordes de secciones al imprimir */
          padding: 0;
        }
      }

      /* Ocultar elementos no imprimibles durante la exportaci√≥n a PDF */
      body.exportando .no-print,
      body.exportando .no-print * {
        display: none !important;
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <div id="formulario">
      <h3 style="text-align: center; color: #007bff">
        üìã Formulario de Control de Servicios
      </h3>
      <div class="form-section">
        <label>üìÖ Fecha: <input type="date" id="fecha" required /></label>
        <div class="form-row">
          <label>üë§ Cliente: <input type="text" id="cliente" required /></label>
          <label>üÜî RUC: <input type="text" id="ruc" /></label>
        </div>
        <div class="form-row">
          <label
            >üöó Veh√≠culo: <input type="text" id="vehiculo" required
          /></label>
          <label>üî¢ Chapa: <input type="text" id="chapa" required /></label>
        </div>
        <div class="form-row">
          <label>üßë‚Äçüîß Mec√°nico: <input type="text" id="mecanico" /></label>
          <label>üßæ Factura N¬∞: <input type="text" id="factura" /></label>
        </div>
      </div>

      <div class="form-section">
        <label>üõ† Servicios realizados:</label>
        <table id="tabla-servicios-realizados">
          <thead>
            <tr>
              <th>Servicio</th>
              <th>Monto</th>
              <th class="no-print">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Fila inicial de ejemplo para servicios realizados -->
            <tr>
              <td>
                <input
                  type="text"
                  class="servicio-realizado"
                  required
                  readonly
                />
              </td>
              <td>
                <input
                  type="number"
                  class="monto-servicio-realizado"
                  value="0"
                  min="0"
                  readonly
                />
              </td>
              <td class="no-print">
                <button onclick="editarFila(this)">‚úèÔ∏è</button>
                <button onclick="eliminarFila(this)">üóë</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="no-print">
          <button onclick="toggleEdicion()">
            üîê Bloquear/Desbloquear Campos
          </button>
          <button onclick="agregarServicioRealizado()">
            ‚ûï Agregar Servicio
          </button>
        </div>
        <strong>Total del servicio: <span id="montoServicio">0</span></strong>
      </div>

      <label>üì¶ √çtems utilizados:</label>
      <table id="tabla-servicios">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Cantidad</th>
            <th>Descripci√≥n</th>
            <th>Precio</th>
            <th>Total</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Fila inicial de ejemplo para √≠tems -->
          <tr>
            <td><input type="text" class="codigo" readonly /></td>
            <td>
              <input
                type="number"
                class="cantidad"
                value="1"
                min="0"
                readonly
              />
            </td>
            <td><input type="text" class="descripcion" readonly /></td>
            <td>
              <input type="number" class="precio" value="0" min="0" readonly />
            </td>
            <td class="total">0</td>
            <td class="no-print">
              <button onclick="editarFila(this)">‚úèÔ∏è</button>
              <button onclick="eliminarFila(this)">üóë</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="no-print">
        <button onclick="toggleEdicion()">
          üîê Bloquear/Desbloquear Campos
        </button>
        <button onclick="agregarFila()">‚ûï Agregar √çtem</button>
        <button onclick="calcularTotales()">üîÑ Recalcular Totales</button>
        <button onclick="guardarHistorial()">üíæ Guardar Control</button>
        <button onclick="generarPDF()">üìÑ Generar PDF</button>
        <button onclick="limpiarFormulario()">üßπ Limpiar Formulario</button>
      </div>

      <p><strong>Total √≠tems:</strong> <span id="total-general">0</span></p>
      <p><strong>Diferencia:</strong> <span id="diferencia">0</span></p>
      <p>
        <strong>Monto total final:</strong>
        <span id="monto-total-final">0</span>
      </p>
    </div>

    <div class="form-section">
      <h3 style="color: #007bff">üìÅ Historial de Controles Guardados</h3>
      <div id="historial-lista">
        <!-- Aqu√≠ se cargar√° el historial de controles -->
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        actualizarEventos(); // Asigna eventos a los inputs existentes
        calcularTotales(); // Calcula los totales iniciales
        habilitarEnterParaTabular(); // Habilita la navegaci√≥n con Enter
        mostrarHistorial(); // Muestra el historial guardado al cargar la p√°gina
      });

      /* Funciones para la gesti√≥n de tablas (Servicios e √çtems) */

      /**
       * Agrega una nueva fila a la tabla de √≠tems utilizados.
       * @param {string} codigo - C√≥digo del √≠tem (opcional, para cargar desde historial).
       * @param {number} cantidad - Cantidad del √≠tem (opcional, para cargar desde historial).
       * @param {string} descripcion - Descripci√≥n del √≠tem (opcional, para cargar desde historial).
       * @param {number} precio - Precio unitario del √≠tem (opcional, para cargar desde historial).
       */
      function agregarFila(
        codigo = "",
        cantidad = 1,
        descripcion = "",
        precio = 0
      ) {
        const fila = document.createElement("tr");
        fila.innerHTML = `
    <td><input type="text" class="codigo" value="${codigo}" readonly></td>
    <td><input type="number" class="cantidad" value="${cantidad}" min="0" readonly></td>
    <td><input type="text" class="descripcion" value="${descripcion}" readonly></td>
    <td><input type="number" class="precio" value="${precio}" min="0" readonly></td>
    <td class="total">0</td>
    <td class="no-print">
      <button onclick="editarFila(this)">‚úèÔ∏è</button>
      <button onclick="eliminarFila(this)">üóë</button>
    </td>
  `;
        document.querySelector("#tabla-servicios tbody").appendChild(fila);
        actualizarEventos(); // Re-asigna eventos a la nueva fila
        habilitarEnterParaTabular(); // Re-habilita la navegaci√≥n con Enter
        calcularTotales(); // Recalcula los totales
      }

      /**
       * Agrega una nueva fila a la tabla de servicios realizados.
       * @param {string} servicio - Nombre del servicio (opcional, para cargar desde historial).
       * @param {number} monto - Monto del servicio (opcional, para cargar desde historial).
       */
      function agregarServicioRealizado(servicio = "", monto = 0) {
        const fila = document.createElement("tr");
        fila.innerHTML = `
    <td><input type="text" class="servicio-realizado" value="${servicio}" required readonly></td>
    <td><input type="number" class="monto-servicio-realizado" value="${monto}" min="0" readonly></td>
    <td class="no-print">
      <button onclick="editarFila(this)">‚úèÔ∏è</button>
      <button onclick="eliminarFila(this)">üóë</button>
    </td>
  `;
        document
          .querySelector("#tabla-servicios-realizados tbody")
          .appendChild(fila);
        actualizarEventos(); // Re-asigna eventos a la nueva fila
        habilitarEnterParaTabular(); // Re-habilita la navegaci√≥n con Enter
        calcularTotales(); // Recalcula los totales
      }

      /**
       * Habilita la edici√≥n de los campos de una fila de tabla.
       * Reemplaza el bot√≥n de editar por un bot√≥n de guardar.
       * @param {HTMLElement} btn - El bot√≥n de editar que fue clickeado.
       */
      function editarFila(btn) {
        const row = btn.closest("tr");
        row
          .querySelectorAll("input")
          .forEach((i) => i.removeAttribute("readonly"));
        // Reemplazar el bot√≥n de editar con un bot√≥n de guardar para la fila
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "üíæ";
        saveBtn.onclick = function () {
          guardarFilaEditada(this);
        };
        btn.parentNode.replaceChild(saveBtn, btn);
      }

      /**
       * Guarda los cambios realizados en una fila editada y vuelve a bloquear los campos.
       * Reemplaza el bot√≥n de guardar por el bot√≥n de editar original.
       * @param {HTMLElement} btn - El bot√≥n de guardar que fue clickeado.
       */
      function guardarFilaEditada(btn) {
        const row = btn.closest("tr");
        row
          .querySelectorAll("input")
          .forEach((i) => i.setAttribute("readonly", true));
        // Reemplazar el bot√≥n de guardar con el bot√≥n de editar original
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è";
        editBtn.onclick = function () {
          editarFila(this);
        };
        btn.parentNode.replaceChild(editBtn, btn);
        calcularTotales(); // Recalcula los totales despu√©s de guardar cambios
      }

      /**
       * Elimina la fila de la tabla a la que pertenece el bot√≥n.
       * @param {HTMLElement} btn - El bot√≥n de eliminar que fue clickeado.
       */
      function eliminarFila(btn) {
        btn.closest("tr").remove();
        calcularTotales(); // Recalcula los totales despu√©s de eliminar una fila
      }

      /**
       * Asigna el evento 'input' a los campos de cantidad, precio y monto de servicio
       * para que se recalcule el total autom√°ticamente al cambiar sus valores.
       */
      function actualizarEventos() {
        document
          .querySelectorAll(".cantidad, .precio, .monto-servicio-realizado")
          .forEach((inp) => {
            inp.oninput = calcularTotales;
          });
      }

      /* Funciones para el c√°lculo de totales */

      /**
       * Calcula y actualiza los totales de √≠tems, servicios, diferencia y monto total final.
       */
      function calcularTotales() {
        let totalItems = 0;
        document.querySelectorAll("#tabla-servicios tbody tr").forEach((r) => {
          const cant = parseFloat(r.querySelector(".cantidad")?.value || 0);
          const prec = parseFloat(r.querySelector(".precio")?.value || 0);
          const tot = cant * prec;
          r.querySelector(".total").textContent = tot.toFixed(0); // Muestra el total del √≠tem sin decimales
          totalItems += tot;
        });
        document.getElementById("total-general").textContent =
          totalItems.toFixed(0); // Muestra el total general de √≠tems

        let totalServ = 0;
        document.querySelectorAll(".monto-servicio-realizado").forEach((i) => {
          totalServ += parseFloat(i.value) || 0;
        });
        document.getElementById("montoServicio").textContent =
          totalServ.toFixed(0); // Muestra el total de servicios

        document.getElementById("diferencia").textContent = (
          totalServ - totalItems
        ).toFixed(0); // Calcula y muestra la diferencia
        document.getElementById("monto-total-final").textContent =
          totalServ.toFixed(0); // El monto total final es el total de servicios
      }

      /* Funciones de Usabilidad */

      /**
       * Habilita la navegaci√≥n entre campos de entrada usando la tecla Enter.
       */
      function habilitarEnterParaTabular() {
        const inputs = [...document.querySelectorAll("input,textarea")];
        inputs.forEach((inp, idx) => {
          inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault(); // Previene el comportamiento por defecto de Enter (ej. enviar formulario)
              inputs[idx + 1]?.focus(); // Mueve el foco al siguiente input
            }
          });
        });
      }

      /**
       * Alterna el atributo 'readonly' de todos los campos de entrada del formulario
       * que no est√©n dentro de un elemento con la clase 'no-print'.
       */
      function toggleEdicion() {
        document.querySelectorAll("input").forEach((inp) => {
          if (!inp.closest(".no-print")) {
            // Asegura que no afecte los inputs de los botones de acci√≥n
            inp.toggleAttribute("readonly");
          }
        });
      }

      /* Funciones de Exportaci√≥n (PDF) */

      /**
       * Genera un archivo PDF del formulario utilizando la librer√≠a html2pdf.js.
       */
      function generarPDF() {
        document.body.classList.add("exportando"); // A√±ade clase para ocultar elementos no imprimibles
        html2pdf()
          .from(document.getElementById("formulario"))
          .set({
            margin: 5,
            filename: "reporte_servicios.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 1.5, scrollY: 0 },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            pagebreak: { mode: ["avoid-all", "css", "legacy"] }, // Estrategia de salto de p√°gina
          })
          .save()
          .then(() => {
            document.body.classList.remove("exportando"); // Elimina la clase despu√©s de generar el PDF
          });
      }

      /* Funciones de Historial (localStorage) */

      const KEY = "historialControles"; // Clave para almacenar el historial en localStorage

      /**
       * Recolecta todos los datos del formulario actual en un objeto JavaScript.
       * @returns {object} Un objeto con todos los datos del control de servicio.
       */
      function recolectarDatos() {
        const serviciosRealizados = [];
        document
          .querySelectorAll("#tabla-servicios-realizados tbody tr")
          .forEach((row) => {
            serviciosRealizados.push({
              servicio: row.querySelector(".servicio-realizado").value,
              monto:
                parseFloat(
                  row.querySelector(".monto-servicio-realizado").value
                ) || 0,
            });
          });

        const items = [];
        document
          .querySelectorAll("#tabla-servicios tbody tr")
          .forEach((row) => {
            items.push({
              codigo: row.querySelector(".codigo").value,
              cantidad: parseFloat(row.querySelector(".cantidad").value) || 0,
              descripcion: row.querySelector(".descripcion").value,
              precio: parseFloat(row.querySelector(".precio").value) || 0,
            });
          });

        const data = {
          fecha: document.getElementById("fecha").value,
          cliente: document.getElementById("cliente").value,
          ruc: document.getElementById("ruc").value,
          vehiculo: document.getElementById("vehiculo").value,
          chapa: document.getElementById("chapa").value,
          mecanico: document.getElementById("mecanico").value,
          factura: document.getElementById("factura").value,
          serviciosRealizados: serviciosRealizados,
          items: items,
          totales: {
            totalItems: document.getElementById("total-general").textContent,
            totalServicios:
              document.getElementById("montoServicio").textContent,
            diferencia: document.getElementById("diferencia").textContent,
            montoFinal:
              document.getElementById("monto-total-final").textContent,
          },
        };
        return data;
      }

      /**
       * Guarda el control de servicio actual en el historial de localStorage.
       */
      function guardarHistorial() {
        const nuevoControl = recolectarDatos();
        let historial = JSON.parse(localStorage.getItem(KEY)) || []; // Obtiene el historial o un array vac√≠o
        historial.push(nuevoControl); // A√±ade el nuevo control
        localStorage.setItem(KEY, JSON.stringify(historial)); // Guarda el historial actualizado
        alert("Control guardado en el historial local.");
        mostrarHistorial(); // Actualiza la lista visible del historial
        // Opcional: limpiarFormulario(); // Descomentar si se desea limpiar el formulario despu√©s de guardar
      }

      /**
       * Muestra el historial de controles guardados en la interfaz.
       */
      function mostrarHistorial() {
        const historialLista = document.getElementById("historial-lista");
        historialLista.innerHTML = ""; // Limpia la lista antes de volver a mostrar
        let historial = JSON.parse(localStorage.getItem(KEY)) || [];

        if (historial.length === 0) {
          historialLista.innerHTML =
            "<p>No hay controles guardados en el historial.</p>";
          return;
        }

        historial.forEach((control, index) => {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("historial-item");
          itemDiv.innerHTML = `
      <p><strong>Fecha:</strong> ${control.fecha || "N/A"}</p>
      <p><strong>Cliente:</strong> ${control.cliente || "N/A"}</p>
      <p><strong>Veh√≠culo:</strong> ${control.vehiculo || "N/A"} - ${
            control.chapa || "N/A"
          }</p>
      <p><strong>Monto Total Final:</strong> ${
        control.totales.montoFinal || "0"
      }</p>
      <div class="no-print">
        <button onclick="cargarHistorial(${index})">Cargar</button>
        <button onclick="eliminarHistorial(${index})">Eliminar</button>
      </div>
    `;
          historialLista.appendChild(itemDiv);
        });
      }

      /**
       * Carga un control espec√≠fico del historial en el formulario.
       * @param {number} index - El √≠ndice del control a cargar en el array del historial.
       */
      function cargarHistorial(index) {
        let historial = JSON.parse(localStorage.getItem(KEY)) || [];
        if (index >= 0 && index < historial.length) {
          const control = historial[index];

          // Cargar datos principales del formulario
          document.getElementById("fecha").value = control.fecha;
          document.getElementById("cliente").value = control.cliente;
          document.getElementById("ruc").value = control.ruc;
          document.getElementById("vehiculo").value = control.vehiculo;
          document.getElementById("chapa").value = control.chapa;
          document.getElementById("mecanico").value = control.mecanico;
          document.getElementById("factura").value = control.factura;

          // Limpiar tablas actuales antes de cargar nuevos datos
          document.querySelector(
            "#tabla-servicios-realizados tbody"
          ).innerHTML = "";
          document.querySelector("#tabla-servicios tbody").innerHTML = "";

          // Cargar servicios realizados
          if (
            control.serviciosRealizados &&
            control.serviciosRealizados.length > 0
          ) {
            control.serviciosRealizados.forEach((sr) => {
              agregarServicioRealizado(sr.servicio, sr.monto);
            });
          } else {
            // Si no hay servicios, agregar una fila vac√≠a por defecto
            agregarServicioRealizado();
          }

          // Cargar √≠tems utilizados
          if (control.items && control.items.length > 0) {
            control.items.forEach((item) => {
              agregarFila(
                item.codigo,
                item.cantidad,
                item.descripcion,
                item.precio
              );
            });
          } else {
            // Si no hay √≠tems, agregar una fila vac√≠a por defecto
            agregarFila();
          }

          calcularTotales(); // Recalcular totales despu√©s de cargar los datos
          alert("Control cargado exitosamente.");
        } else {
          alert("Error: √çndice de historial no v√°lido.");
        }
      }

      /**
       * Elimina un control espec√≠fico del historial de localStorage.
       * @param {number} index - El √≠ndice del control a eliminar.
       */
      function eliminarHistorial(index) {
        let historial = JSON.parse(localStorage.getItem(KEY)) || [];
        if (
          confirm(
            "¬øEst√°s seguro de que quieres eliminar este control del historial? Esta acci√≥n es irreversible."
          )
        ) {
          historial.splice(index, 1); // Elimina el elemento en el √≠ndice dado
          localStorage.setItem(KEY, JSON.stringify(historial)); // Guarda el historial actualizado
          mostrarHistorial(); // Actualiza la lista visible del historial
          alert("Control eliminado del historial.");
        }
      }

      /**
       * Limpia todos los campos del formulario y restablece las tablas a su estado inicial.
       */
      function limpiarFormulario() {
        // Limpiar campos principales
        document.getElementById("fecha").value = "";
        document.getElementById("cliente").value = "";
        document.getElementById("ruc").value = "";
        document.getElementById("vehiculo").value = "";
        document.getElementById("chapa").value = "";
        document.getElementById("mecanico").value = "";
        document.getElementById("factura").value = "";

        // Limpiar y restablecer tabla de servicios realizados
        document.querySelector("#tabla-servicios-realizados tbody").innerHTML =
          "";
        agregarServicioRealizado(); // Agrega una fila vac√≠a por defecto

        // Limpiar y restablecer tabla de √≠tems utilizados
        document.querySelector("#tabla-servicios tbody").innerHTML = "";
        agregarFila(); // Agrega una fila vac√≠a por defecto

        calcularTotales(); // Recalcular totales despu√©s de limpiar
        actualizarEventos(); // Re-adjuntar eventos a los nuevos inputs
        habilitarEnterParaTabular(); // Re-habilitar tabulaci√≥n
        alert("Formulario limpiado");
      }
    </script>
  </body>
</html>
```